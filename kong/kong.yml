_format_version: "3.0"
services:
  - name: backend
    url: $KONG_BACKEND_URL
    routes:
      - name: backend-api
        paths:
          - /api
        strip_path: false
      - name: backend-admin
        paths:
          - /api/admin
        strip_path: false
      - name: backend-payments
        paths:
          - /api/payments
        strip_path: false
      - name: backend-login
        paths:
          - /api/auth/login
        strip_path: false
      - name: backend-health
        paths:
          - /healthz
        strip_path: false
  - name: backend-uploads
    url: $KONG_BACKEND_URL
    routes:
      - name: backend-uploads-route
        paths:
          - /uploads
        strip_path: false
plugins:
  - name: request-transformer
    service: backend
    config:
      add:
        # Inject shared secret so backend can verify traffic really passed through Kong
        headers:
          - "x-gateway-secret:${GATEWAY_SHARED_SECRET}"
  - name: request-transformer
    service: backend-uploads
    config:
      add:
        headers:
          - "x-gateway-secret:${GATEWAY_SHARED_SECRET}"
  - name: bot-detection
    service: backend
  - name: response-transformer
    service: backend
    config:
      add:
        # Basic security headers (browser hardening)
        headers:
          - X-Frame-Options:DENY
          - X-Content-Type-Options:nosniff
          - Referrer-Policy:no-referrer
          - Strict-Transport-Security:max-age=31536000; includeSubDomains
  - name: response-transformer
    service: backend-uploads
    config:
      add:
        headers:
          - X-Frame-Options:DENY
          - X-Content-Type-Options:nosniff
          - Referrer-Policy:no-referrer
          - Strict-Transport-Security:max-age=31536000; includeSubDomains
  - name: key-auth
    service: backend
    config:
      # Require API key on real requests; let OPTIONS through via anonymous consumer
      run_on_preflight: false
      anonymous: anonymous-preflight
  - name: acl
    service: backend
    config:
      allow:
        - trusted-clients
      anonymous: anonymous-preflight
  - name: rate-limiting
    service: backend
    config:
      minute: 200
      hour: 2000
      policy: local
      limit_by: ip
  - name: request-size-limiting
    service: backend
    config:
      allowed_payload_size: 1 # MB
      require_content_length: false
  - name: rate-limiting
    route: backend-login
    config:
      minute: 5
      hour: 60
      policy: local
      limit_by: credential
      second: 3
      fault_tolerant: false
  - name: rate-limiting
    route: backend-admin
    config:
      minute: 60
      hour: 600
      policy: local
      limit_by: credential
      second: 5
      fault_tolerant: false
  - name: rate-limiting
    route: backend-payments
    config:
      minute: 40
      hour: 400
      policy: local
      limit_by: credential
      fault_tolerant: false
consumers:
  - username: local-tester
    keyauth_credentials:
      - key: ${KONG_CONSUMER_KEY}
    acls:
      - group: trusted-clients
  - username: anonymous-preflight
    acls:
      - group: trusted-clients
